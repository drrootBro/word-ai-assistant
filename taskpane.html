<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BYOK AI Assistant</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 18px;
            color: #333;
        }

        .section {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 18px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-primary { background: #0078D4; color: #ffffff; }
        .btn-primary:disabled { opacity: 0.7; cursor: default; }

        .btn-secondary { background: #efefef; color: #333; }

        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .info-text {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .status {
            font-size: 12px;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            display: none;
        }

        .status.success { background: #e8f5e9; color: #2e7d32; display: block; }
        .status.error   { background: #ffebee; color: #c62828; display: block; }

        #accountSection {
            border-left: 4px solid #0078D4;
        }

        #premiumCTA {
            margin-top: 10px;
            font-size: 13px;
            color: #0078D4;
        }

        a.link {
            font-size: 12px;
            color: #0078D4;
            text-decoration: none;
        }

        a.link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <h1>BYOK AI Assistant for Word</h1>

    <!-- ğŸ‘¤ Account & Trial -->
    <div class="section" id="accountSection">
        <div class="section-title">ğŸ‘¤ Account & Trial</div>

        <input type="email" id="userEmailInput" placeholder="Enter your email (for license)â€¦" />
        <button class="btn-secondary" id="saveEmailBtn">ğŸ’¾ Save Email</button>

        <div class="info-text" id="emailDisplay">Not saved yet.</div>

        <!-- Trial -->
        <div class="status" id="trialStatus"></div>

        <!-- CTA appears only when trial ends -->
        <div id="premiumCTA" style="display:none;">
            â­ Lifetime premium unlock available.  
            <a href="#" id="upgradeLink">Upgrade now</a>
        </div>
    </div>

    <!-- ğŸ”‘ API -->
    <div class="section">
        <select id="modelSelect">
            <option value="gemini">Google Gemini (Free)</option>
            <option value="openai">OpenAI GPT-4</option>
            <option value="claude">Anthropic Claude</option>
        </select>

        <div class="section-title">
            ğŸ”‘ <span id="apiKeyLabel">Gemini API Key</span>
        </div>

        <input type="password" id="apiKeyInput" placeholder="Enter your API key..." />
        <button class="btn-secondary" id="saveApiKeyBtn">ğŸ’¾ Save Key</button>

        <a class="link" id="getKeyLink" href="https://aistudio.google.com/app/apikey" target="_blank">
            ğŸ‘‰ Get free Gemini API Key
        </a>

        <div id="saveStatus" class="status"></div>
    </div>

    <!-- âœ¨ Generate -->
    <div class="section">
        <div class="section-title">âœ¨ Generate Content</div>
        <div class="info-text">ğŸ“ Inserts at cursor position</div>

        <textarea id="promptInput" placeholder="e.g., Write an introduction about AI and productivity..."></textarea>

        <button class="btn-primary" id="generateBtn">âœ¨ Generate & Insert</button>
        <div id="generateStatus" class="status"></div>
    </div>

    <!-- ğŸ“ Edit -->
    <div class="section">
        <div class="section-title">ğŸ“ Edit Selection</div>
        <div class="info-text">âœ¨ Highlight text first</div>

        <div class="btn-grid">
            <button class="btn-secondary" data-action="rewrite">âœï¸ Rewrite</button>
            <button class="btn-secondary" data-action="summarize">ğŸ“„ Summarize</button>
            <button class="btn-secondary" data-action="expand">ğŸ“ˆ Expand</button>
            <button class="btn-secondary" data-action="format">âœ¨ Format</button>
        </div>

        <textarea id="customInstruction" placeholder="Or enter custom instruction..."></textarea>

        <button class="btn-primary" id="runCustomBtn">ğŸš€ Run on Selected</button>

        <div id="editStatus" class="status"></div>
    </div>
<script>
/*************************************************************
 * Office Initialization
 *************************************************************/
Office.onReady(() => {
    console.log("Office ready.");

    document.getElementById("saveApiKeyBtn").addEventListener("click", saveApiKey);
    document.getElementById("generateBtn").addEventListener("click", generateContent);

    document.getElementById("modelSelect").addEventListener("change", () => {
        updateApiKeyLabel();
        updateGetKeyLink();
    });

    // Preset edit buttons
    document.querySelectorAll("[data-action]").forEach(btn => {
        btn.addEventListener("click", () => editPreset(btn.dataset.action));
    });

    // Custom instruction button
    document.getElementById("runCustomBtn").addEventListener("click", runCustom);

    // Email / Trial init
    document.getElementById("saveEmailBtn").addEventListener("click", saveUserEmail);

    initUserEmailAndTrial();
    updateApiKeyLabel();
    updateGetKeyLink();
});

/*************************************************************
 * Step 1 â€” Email + Trial
 *************************************************************/
const TRIAL_DAYS = 5;

function initUserEmailAndTrial() {
    console.log("Initialize Email + Trial");

    const savedEmail = localStorage.getItem("byok_user_email");
    if (savedEmail) {
        document.getElementById("userEmailInput").value = savedEmail;
        updateEmailDisplay(savedEmail);
    }

    let start = localStorage.getItem("byok_trial_start");
    if (!start) {
        start = Date.now().toString();
        localStorage.setItem("byok_trial_start", start);
    }

    updateTrialStatus();
}

function saveUserEmail() {
    const emailInput = document.getElementById("userEmailInput");
    const email = emailInput.value.trim();

    if (!email || !email.includes("@")) {
        showStatus("saveStatus", "âš ï¸ Please enter a valid email", "error");
        return;
    }

    localStorage.setItem("byok_user_email", email);
    updateEmailDisplay(email);

    // Show success in its own box (not overwrite trialStatus)
    showStatus("saveStatus", "âœ… Email saved", "success");

    // Re-render trial UI
    updateTrialStatus();
}

function updateEmailDisplay(email) {
    document.getElementById("emailDisplay").textContent = `Using email: ${email}`;
}

/** Trial countdown display */
function updateTrialStatus() {
    const el = document.getElementById("trialStatus");
    const cta = document.getElementById("premiumCTA");

    const start = Number(localStorage.getItem("byok_trial_start") || Date.now());
    const now = Date.now();

    const daysUsed = Math.floor((now - start) / (24 * 3600 * 1000));
    const daysLeft = TRIAL_DAYS - daysUsed;

    if (daysLeft > 0) {
        // Trial active
        el.className = "status success";
        el.style.display = "block";
        el.textContent = `ğŸŸ¢ Free trial: ${daysLeft} day(s) remaining`;

        // Show CTA even during trial
        cta.style.display = "block";
        cta.innerHTML = `
            â­ Want lifetime premium early?<br>
            <button id="earlyPayBtn" class="cta-btn">Unlock Premium Now</button>
        `;

        // Bind button
        setTimeout(() => {
            const btn = document.getElementById("earlyPayBtn");
            if (btn) btn.addEventListener("click", openPaymentPage);
        }, 50);

    } else {
        // Trial ended
        el.className = "status error";
        el.style.display = "block";
        el.textContent = "ğŸ”´ Free trial ended â€” upgrade required";

        cta.style.display = "block";
        cta.innerHTML = `
            â­ Lifetime premium unlock available<br>
            <button id="earlyPayBtn" class="cta-btn">Unlock Premium Now</button>
        `;

        setTimeout(() => {
            const btn = document.getElementById("earlyPayBtn");
            if (btn) btn.addEventListener("click", openPaymentPage);
        }, 50);
    }
}


/*************************************************************
 * Model Config â€” Gemini 2.0 Flash
 *************************************************************/
const modelConfig = {
    gemini: {
        name: "Gemini API Key",
        link: "https://aistudio.google.com/app/apikey",
        endpoint:
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent"
    },
    openai: {
        name: "OpenAI API Key",
        link: "https://platform.openai.com/api-keys",
        endpoint: "https://api.openai.com/v1/chat/completions"
    },
    claude: {
        name: "Anthropic API Key",
        link: "https://console.anthropic.com/",
        endpoint: "https://api.anthropic.com/v1/messages"
    }
};

function updateApiKeyLabel() {
    const model = document.getElementById("modelSelect").value;
    const cfg = modelConfig[model];
    document.getElementById("apiKeyLabel").textContent = cfg.name;

    const saved = localStorage.getItem(`apiKey_${model}`);
    document.getElementById("apiKeyInput").value = saved || "";
}

function updateGetKeyLink() {
    const model = document.getElementById("modelSelect").value;
    const linkEl = document.getElementById("getKeyLink");

    linkEl.style.display = "inline-block";

    if (model === "gemini") {
        linkEl.href = modelConfig.gemini.link;
        linkEl.textContent = "ğŸ‘‰ Get free Gemini API key";
    } else if (model === "openai") {
        linkEl.href = modelConfig.openai.link;
        linkEl.textContent = "ğŸ‘‰ Get OpenAI API key";
    } else {
        linkEl.href = modelConfig.claude.link;
        linkEl.textContent = "ğŸ‘‰ Get Anthropic API key";
    }
}

function saveApiKey() {
    const model = document.getElementById("modelSelect").value;
    const key = document.getElementById("apiKeyInput").value.trim();

    if (!key) {
        showStatus("saveStatus", "âš ï¸ Please enter an API key", "error");
        return;
    }

    localStorage.setItem(`apiKey_${model}`, key);
    showStatus("saveStatus", "API key saved! âœ…", "success");
}

/*************************************************************
 * Generate Content
 *************************************************************/
async function generateContent() {
    const prompt = document.getElementById("promptInput").value.trim();
    if (!prompt) {
        showStatus("generateStatus", "âš ï¸ Please enter a prompt", "error");
        return;
    }

    const model = document.getElementById("modelSelect").value;
    const apiKey = localStorage.getItem(`apiKey_${model}`);
    if (!apiKey) {
        showStatus("generateStatus", "âš ï¸ Save your API key first", "error");
        return;
    }

    const btn = document.getElementById("generateBtn");
    btn.disabled = true;
    btn.textContent = "â³ Generatingâ€¦";

    try {
        const result = await callAI(model, apiKey, prompt);
        await insertText(result);
        showStatus("generateStatus", "Inserted successfully! ğŸ‰", "success");
    } catch (err) {
        console.error(err);
        showStatus("generateStatus", "âŒ " + err.message, "error");
    } finally {
        btn.disabled = false;
        btn.textContent = "âœ¨ Generate & Insert";
    }
}

/*************************************************************
 * Edit with preset prompts
 *************************************************************/
async function editPreset(action) {
    const model = document.getElementById("modelSelect").value;
    const apiKey = localStorage.getItem(`apiKey_${model}`);

    if (!apiKey) {
        showStatus("editStatus", "âš ï¸ Save your API key first", "error");
        return;
    }

    try {
        await Word.run(async (context) => {
            const selection = context.document.getSelection();
            selection.load("text");
            await context.sync();

            const selectedText = selection.text.trim();
            if (!selectedText) {
                showStatus("editStatus", "âš ï¸ Select some text first", "error");
                return;
            }

            const prompts = {
                rewrite: `Rewrite this text clearly and professionally:\n\n${selectedText}`,
                summarize: `Summarize the following text:\n\n${selectedText}`,
                expand: `Expand on this text with more details:\n\n${selectedText}`,
                format: `Improve the formatting and clarity:\n\n${selectedText}`
            };

            const prompt = prompts[action];
            const response = await callAI(model, apiKey, prompt);

            selection.insertText(response, Word.InsertLocation.replace);
            await context.sync();

            showStatus("editStatus", "Done! ğŸ‰", "success");
        });
    } catch (err) {
        console.error(err);
        showStatus("editStatus", "âŒ " + err.message, "error");
    }
}

/*************************************************************
 * Edit â€” Custom instruction
 *************************************************************/
async function runCustom() {
    const instruction = document.getElementById("customInstruction").value.trim();
    if (!instruction) {
        showStatus("editStatus", "âš ï¸ Enter a custom instruction", "error");
        return;
    }

    const model = document.getElementById("modelSelect").value;
    const apiKey = localStorage.getItem(`apiKey_${model}`);
    if (!apiKey) {
        showStatus("editStatus", "âš ï¸ Save your API key first", "error");
        return;
    }

    try {
        await Word.run(async (context) => {
            const selection = context.document.getSelection();
            selection.load("text");
            await context.sync();

            const selected = selection.text.trim();
            if (!selected) {
                showStatus("editStatus", "âš ï¸ Select text first", "error");
                return;
            }

            const prompt = `${instruction}\n\nText:\n${selected}`;
            const output = await callAI(model, apiKey, prompt);

            selection.insertText(output, Word.InsertLocation.replace);
            await context.sync();

            showStatus("editStatus", "âœ… Custom applied!", "success");
        });
    } catch (err) {
        console.error(err);
        showStatus("editStatus", "âŒ " + err.message, "error");
    }
}

/*************************************************************
 * AI API Logic â€” Gemini 2.0 Flash
 *************************************************************/
async function callAI(model, apiKey, prompt) {
    const cfg = modelConfig[model];

    // --- Gemini 2.0 Flash ---
    if (model === "gemini") {
        const url = `${cfg.endpoint}?key=${apiKey}`;
        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [
                    {
                        parts: [{ text: prompt }]
                    }
                ]
            })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || "Gemini Error");

        return data.candidates[0].content.parts[0].text;
    }

    // --- OpenAI ---
    if (model === "openai") {
        const res = await fetch(cfg.endpoint, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [{ role: "user", content: prompt }]
            })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || "OpenAI Error");

        return data.choices[0].message.content;
    }

    // --- Claude ---
    if (model === "claude") {
        const res = await fetch(cfg.endpoint, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-api-key": apiKey,
                "anthropic-version": "2023-06-01"
            },
            body: JSON.stringify({
                model: "claude-3-5-sonnet-20241022",
                max_tokens: 2000,
                messages: [{ role: "user", content: prompt }]
            })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || "Claude Error");

        return data.content[0].text;
    }

    throw new Error("Model not implemented.");
}

/*************************************************************
 * Insert text to Word
 *************************************************************/
async function insertText(text) {
    await Word.run(async (context) => {
        const selection = context.document.getSelection();
        selection.insertText(text, Word.InsertLocation.end);
        await context.sync();
    });
}

/*************************************************************
 * Status helper
 *************************************************************/
function showStatus(id, msg, type) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.className = `status ${type}`;
    el.style.display = "block";

    // Only auto-hide non-trial messages
    if (id !== "trialStatus") {
        setTimeout(() => { el.style.display = "none"; }, 3500);
    }
}
    
function openPaymentPage() {
    // ğŸš¨ ä¹‹åæˆ‘ä¼šå¸®ä½ æ¢æˆ Lemon Squeezy checkout URL
    window.open("https://your-checkout-url-here.com", "_blank");
}

</script>
</body>
</html>
