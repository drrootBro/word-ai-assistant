<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BYOK AI Assistant</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 18px;
            color: #333;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 18px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-primary { background: #0078D4; color: white; }
        .btn-secondary { background: #efefef; color: #333; }

        .info-text { font-size: 12px; color: #666; margin-bottom: 8px; }

        .status {
            font-size: 12px;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            display: none;
        }

        .status.success { background: #e8f5e9; color: #2e7d32; display: block; }
        .status.error   { background: #ffebee; color: #c62828; display: block; }

        /* Account & Trial highlight */
        #accountSection {
            border-left: 4px solid #0078D4;
        }
    </style>
</head>

<body>

    <h1>AI Writing Assistant</h1>

    <!-- STEP 1 ‚Äî Email + Trial -->
    <div class="section" id="accountSection">
        <div class="section-title">üë§ Account & Trial</div>

        <input type="email" id="userEmailInput" placeholder="Enter your email (used for license)‚Ä¶">
        <button class="btn-secondary" id="saveEmailBtn">üíæ Save Email</button>

        <div class="info-text" id="emailDisplay">Not saved yet.</div>

        <div class="status" id="trialStatus"></div>
    </div>

    <!-- Model Selection -->
    <div class="section">
        <select id="modelSelect">
            <option value="gemini">Google Gemini (Free)</option>
            <option value="openai">OpenAI GPT-4</option>
            <option value="claude">Anthropic Claude</option>
        </select>

        <div class="section-title">üîë <span id="apiKeyLabel">Gemini API Key</span></div>
        <input type="password" id="apiKeyInput" placeholder="Enter your API key...">
        <button class="btn-secondary" id="saveApiKeyBtn">üíæ Save Key</button>

        <div id="saveStatus" class="status"></div>
    </div>

    <!-- Generate Content -->
    <div class="section">
        <div class="section-title">‚ú® Generate Content</div>
        <textarea id="promptInput" placeholder="Write an article about AI..."></textarea>
        <button class="btn-primary" id="generateBtn">‚ú® Generate & Insert</button>
        <div id="generateStatus" class="status"></div>
    </div>

    <!-- Edit Selection -->
    <div class="section">
        <div class="section-title">üìù Edit Selection</div>
        <button class="btn-secondary" onclick="editText('rewrite')">‚úçÔ∏è Rewrite</button>
        <button class="btn-secondary" onclick="editText('summarize')">üìÑ Summarize</button>
        <button class="btn-secondary" onclick="editText('expand')">üìà Expand</button>
        <button class="btn-secondary" onclick="editText('format')">‚ú® Format</button>
        <div id="editStatus" class="status"></div>
    </div>

<script>

/*************************************************************
 * Office Initialization
 *************************************************************/
Office.onReady(() => {
    console.log("Office ready.");

    document.getElementById("saveApiKeyBtn").addEventListener("click", saveApiKey);
    document.getElementById("generateBtn").addEventListener("click", generateContent);

    document.getElementById("modelSelect").addEventListener("change", updateApiKeyLabel);

    initUserEmailAndTrial();
    updateApiKeyLabel();
});

/*************************************************************
 * Step 1 ‚Äî Email + Trial Logic
 *************************************************************/
const TRIAL_DAYS = 5;

function initUserEmailAndTrial() {
    const emailInput = document.getElementById("userEmailInput");
    const saveEmailBtn = document.getElementById("saveEmailBtn");

    saveEmailBtn.addEventListener("click", saveUserEmail);

    // Initialize email
    const savedEmail = localStorage.getItem("byok_user_email");
    if (savedEmail) {
        emailInput.value = savedEmail;
        updateEmailDisplay(savedEmail);
    }

    // Initialize trial start time
    let start = localStorage.getItem("byok_trial_start");
    if (!start) {
        start = Date.now().toString();
        localStorage.setItem("byok_trial_start", start);
    }

    updateTrialStatus();
}

function saveUserEmail() {
    const emailInput = document.getElementById("userEmailInput");
    const email = emailInput.value.trim();
    if (!email || !email.includes("@")) {
        showStatus("trialStatus", "‚ö†Ô∏è Please enter a valid email", "error");
        return;
    }
    localStorage.setItem("byok_user_email", email);
    updateEmailDisplay(email);
    showStatus("trialStatus", "‚úÖ Email saved", "success");
}

function updateEmailDisplay(email) {
    document.getElementById("emailDisplay").textContent = `Using email: ${email}`;
}

function updateTrialStatus() {
    const statusEl = document.getElementById("trialStatus");
    const start = Number(localStorage.getItem("byok_trial_start") || Date.now());
    const now = Date.now();

    const daysUsed = Math.floor((now - start) / (24 * 3600 * 1000));
    const daysLeft = TRIAL_DAYS - daysUsed;

    if (daysLeft > 0) {
        statusEl.className = "status success";
        statusEl.style.display = "block";
        statusEl.textContent = `üü¢ Free trial: ${daysLeft} day(s) remaining`;
    } else {
        statusEl.className = "status error";
        statusEl.style.display = "block";
        statusEl.textContent = "üî¥ Free trial ended ‚Äì upgrade required (payment later)";
    }
}

/*************************************************************
 * Model Config (Gemini MUST use 2.0-flash)
 *************************************************************/
const modelConfig = {
    gemini: {
        name: "Gemini API Key",
        link: "https://aistudio.google.com/app/apikey",
        endpoint:
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent"
    },
    openai: {
        name: "OpenAI API Key",
        link: "https://platform.openai.com/api-keys",
        endpoint: "https://api.openai.com/v1/chat/completions"
    },
    claude: {
        name: "Anthropic API Key",
        link: "https://console.anthropic.com/",
        endpoint: "https://api.anthropic.com/v1/messages"
    }
};

function updateApiKeyLabel() {
    const model = document.getElementById("modelSelect").value;
    const cfg = modelConfig[model];
    document.getElementById("apiKeyLabel").textContent = cfg.name;

    const saved = localStorage.getItem(`apiKey_${model}`);
    document.getElementById("apiKeyInput").value = saved || "";
}

function saveApiKey() {
    const model = document.getElementById("modelSelect").value;
    const key = document.getElementById("apiKeyInput").value.trim();

    if (!key) {
        showStatus("saveStatus", "‚ö†Ô∏è Please enter an API key", "error");
        return;
    }

    localStorage.setItem(`apiKey_${model}`, key);
    showStatus("saveStatus", "API key saved! ‚úÖ", "success");
}

/*************************************************************
 * Generate Content (with Gemini 2.0 Flash)
 *************************************************************/
async function generateContent() {
    const prompt = document.getElementById("promptInput").value.trim();
    if (!prompt) {
        showStatus("generateStatus", "‚ö†Ô∏è Please enter a prompt", "error");
        return;
    }

    const model = document.getElementById("modelSelect").value;
    const apiKey = localStorage.getItem(`apiKey_${model}`);
    if (!apiKey) {
        showStatus("generateStatus", "‚ö†Ô∏è Save your API key first", "error");
        return;
    }

    try {
        const result = await callAI(model, apiKey, prompt);
        await insertText(result);
        showStatus("generateStatus", "Inserted successfully! üéâ", "success");
    } catch (err) {
        showStatus("generateStatus", "‚ùå " + err.message, "error");
    }
}

async function editText(action) {
    const model = document.getElementById("modelSelect").value;
    const apiKey = localStorage.getItem(`apiKey_${model}`);

    if (!apiKey) {
        showStatus("editStatus", "‚ö†Ô∏è Save your API key first", "error");
        return;
    }

    await Word.run(async (context) => {
        const selection = context.document.getSelection();
        selection.load("text");
        await context.sync();

        if (!selection.text.trim()) {
            showStatus("editStatus", "‚ö†Ô∏è Select text first", "error");
            return;
        }

        const prompts = {
            rewrite: `Rewrite this: ${selection.text}`,
            summarize: `Summarize this: ${selection.text}`,
            expand: `Expand on this: ${selection.text}`,
            format: `Improve formatting: ${selection.text}`
        };

        const response = await callAI(model, apiKey, prompts[action]);
        selection.insertText(response, Word.InsertLocation.replace);
        await context.sync();
        showStatus("editStatus", "Done! üéâ", "success");
    });
}

/*************************************************************
 * AI API Logic (Gemini 2.0 Flash)
 *************************************************************/
async function callAI(model, apiKey, prompt) {
    const cfg = modelConfig[model];

    // GEMINI 2.0 FLASH
    if (model === "gemini") {
        const url = `${cfg.endpoint}?key=${apiKey}`;
        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [
                    {
                        parts: [{ text: prompt }]
                    }
                ]
            })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || "Gemini Error");
        return data.candidates[0].content.parts[0].text;
    }

    // OpenAI
    if (model === "openai") {
        const res = await fetch(cfg.endpoint, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [{ role: "user", content: prompt }]
            })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || "OpenAI Error");
        return data.choices[0].message.content;
    }

    // Claude
    if (model === "claude") {
        const res = await fetch(cfg.endpoint, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-api-key": apiKey,
                "anthropic-version": "2023-06-01"
            },
            body: JSON.stringify({
                model: "claude-3-5-sonnet-20241022",
                max_tokens: 2000,
                messages: [{ role: "user", content: prompt }]
            })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || "Claude Error");
        return data.content[0].text;
    }

    throw new Error("Model not implemented.");
}

/*************************************************************
 * Insert Text into Word
 *************************************************************/
async function insertText(text) {
    await Word.run(async (context) => {
        const selection = context.document.getSelection();
        selection.insertText(text, Word.InsertLocation.end);
        await context.sync();
    });
}

/*************************************************************
 * Helper ‚Äî Status Messages
 *************************************************************/
function showStatus(id, msg, type) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.className = `status ${type}`;
    el.style.display = "block";
    setTimeout(() => { el.style.display = "none"; }, 5000);
}

</script>
</body>
</html>

