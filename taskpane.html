<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BYOK AI Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #333;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    select, input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 10px;
      outline: none;
    }

    select:focus, input:focus, textarea:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 1px rgba(26, 115, 232, 0.2);
    }

    select {
      background: white;
      cursor: pointer;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #1a73e8;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #1664c4;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #111827;
      margin-bottom: 6px;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #e5e7eb;
    }

    .btn-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    .info-text {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .link {
      color: #1a73e8;
      text-decoration: none;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .link:hover {
      text-decoration: underline;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .status {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 6px;
      margin-top: 8px;
      display: none;
    }

    .status.success {
      display: block;
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status.error {
      display: block;
      background: #ffebee;
      color: #c62828;
    }
  </style>
</head>
<body>
  <h1>AI Writing Assistant</h1>

  <!-- Provider + API Key -->
  <div class="section">
    <select id="providerSelect">
      <option value="gemini">Google Gemini (Free)</option>
      <option value="openai">OpenAI GPT</option>
    </select>

    <div class="section-title">
      üîë <span id="apiKeyLabel">Gemini API Key</span>
    </div>

    <input type="password" id="apiKeyInput" placeholder="Enter your API key...">

    <button class="btn-secondary" id="saveKeyBtn">üíæ Save Key</button>

    <a href="#" class="link" id="getKeyLink">üëâ Get free API key</a>

    <div id="saveStatus" class="status"></div>
  </div>

  <!-- Generate Content -->
  <div class="section">
    <div class="section-title">‚ú® Generate Content</div>
    <div class="info-text">üìç Inserts at cursor position (or replaces selection)</div>
    <textarea id="promptInput" placeholder="e.g., Write an article about AI writing assistants for busy researchers..."></textarea>
    <button class="btn-primary" id="generateBtn">‚ú® Generate &amp; Insert</button>
    <div id="generateStatus" class="status"></div>
  </div>

  <!-- Edit Selection -->
  <div class="section">
    <div class="section-title">üìù Edit Selection</div>
    <div class="info-text">‚ú® Highlight text first</div>
    <div class="btn-grid">
      <button class="btn-secondary" id="btnRewrite">‚úçÔ∏è Rewrite</button>
      <button class="btn-secondary" id="btnSummarize">üìÑ Summarize</button>
      <button class="btn-secondary" id="btnExpand">üìà Expand</button>
      <button class="btn-secondary" id="btnFormat">‚ú® Format</button>
    </div>
    <div id="editStatus" class="status"></div>
  </div>

  <script>
    // ‚úÖ ÊõøÊç¢Êàê‰Ω†ÁöÑ Apps Script Web App URLÔºà/exec ÁªìÂ∞æÔºâ
    const CONFIG = {
      API_ENDPOINT: "https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec"
    };

    const STORAGE_PREFIX = "byok_word_"; // ÈÅøÂÖçÂíå Docs ÂÜ≤Á™Å

    function getProvider() {
      return document.getElementById("providerSelect").value;
    }

    function getStorageKeyForProvider() {
      return STORAGE_PREFIX + "apiKey_" + getProvider();
    }

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      if (!el) return;
      el.textContent = message;
      el.className = "status " + (type || "");
      el.style.display = "block";
    }

    function clearStatus(elementId) {
      const el = document.getElementById(elementId);
      if (!el) return;
      el.textContent = "";
      el.style.display = "none";
    }

    function setBusy(isBusy) {
      const ids = [
        "saveKeyBtn",
        "generateBtn",
        "btnRewrite",
        "btnSummarize",
        "btnExpand",
        "btnFormat"
      ];
      ids.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = isBusy;
      });
    }

    function updateApiKeyLabelAndLink() {
      const provider = getProvider();
      const labelEl = document.getElementById("apiKeyLabel");
      const linkEl = document.getElementById("getKeyLink");
      if (!labelEl || !linkEl) return;

      if (provider === "gemini") {
        labelEl.textContent = "Gemini API Key";
        linkEl.textContent = "üëâ Get free Gemini API key";
        linkEl.href = "https://aistudio.google.com/app/apikey";
      } else if (provider === "openai") {
        labelEl.textContent = "OpenAI API Key";
        linkEl.textContent = "üëâ Get OpenAI API key";
        linkEl.href = "https://platform.openai.com/api-keys";
      }
    }

    function loadSavedApiKey() {
      const key = localStorage.getItem(getStorageKeyForProvider());
      const input = document.getElementById("apiKeyInput");
      if (input) {
        input.value = key || "";
      }
    }

    function saveApiKey() {
      const input = document.getElementById("apiKeyInput");
      if (!input) return;
      const value = input.value.trim();
      if (!value) {
        showStatus("saveStatus", "Please enter an API key.", "error");
        return;
      }
      localStorage.setItem(getStorageKeyForProvider(), value);
      showStatus("saveStatus", "API key saved locally.", "success");
    }

    async function getSelectionText() {
      return Word.run(async (context) => {
        const range = context.document.getSelection();
        range.load("text");
        await context.sync();
        return range.text || "";
      });
    }

    async function insertOrReplaceText(text) {
      return Word.run(async (context) => {
        const range = context.document.getSelection();
        range.load("text");
        await context.sync();

        if (range.text) {
          range.insertText(text, Word.InsertLocation.replace);
        } else {
          range.insertText(text, Word.InsertLocation.insert);
        }
        await context.sync();
      });
    }

    // ‚úÖ Áªü‰∏ÄË∞ÉÁî®‰Ω†ÁöÑ Apps Script ÂêéÁ´ØÔºàÂíå Docs ‰∏ÄËá¥Ôºâ
    async function callBackend(mode, prompt, selectionText) {
      if (!CONFIG.API_ENDPOINT) {
        throw new Error("API endpoint is not configured.");
      }

      const provider = getProvider();
      const apiKey = localStorage.getItem(getStorageKeyForProvider()) || "";

      if (!apiKey) {
        throw new Error("Please save your API key first.");
      }

      const body = {
        provider: provider,
        apiKey: apiKey,
        mode: mode,                 // "generate" / "rewrite" / "summarize" / "expand" / "format"
        prompt: prompt || "",
        selectionText: selectionText || ""
      };

      const res = await fetch(CONFIG.API_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error("Request failed: " + res.status + " - " + text);
      }

      const data = await res.json();
      if (!data || !data.success) {
        throw new Error((data && data.error) || "Unknown error from backend");
      }
      return data.output;
    }

    async function handleGenerate() {
      clearStatus("generateStatus");
      const prompt = document.getElementById("promptInput").value.trim();
      if (!prompt) {
        showStatus("generateStatus", "Please enter a prompt.", "error");
        return;
      }

      try {
        setBusy(true);
        showStatus("generateStatus", "Calling AI...", "success");
        const output = await callBackend("generate", prompt, "");
        if (!output) {
          showStatus("generateStatus", "AI returned empty result.", "error");
          return;
        }
        await insertOrReplaceText(output);
        showStatus("generateStatus", "Inserted successfully.", "success");
      } catch (err) {
        console.error(err);
        showStatus("generateStatus", "Error: " + (err.message || String(err)), "error");
      } finally {
        setBusy(false);
      }
    }

    async function handleEdit(mode) {
      clearStatus("editStatus");
      try {
        setBusy(true);
        const selectionText = await getSelectionText();
        if (!selectionText) {
          showStatus("editStatus", "Please select some text first.", "error");
          return;
        }
        showStatus("editStatus", "Calling AI...", "success");
        const output = await callBackend(mode, "", selectionText);
        if (!output) {
          showStatus("editStatus", "AI returned empty result.", "error");
          return;
        }

        await Word.run(async (context) => {
          const range = context.document.getSelection();
          range.insertText(output, Word.InsertLocation.replace);
          await context.sync();
        });

        showStatus("editStatus", "Selection updated.", "success");
      } catch (err) {
        console.error(err);
        showStatus("editStatus", "Error: " + (err.message || String(err)), "error");
      } finally {
        setBusy(false);
      }
    }

    Office.onReady((info) => {
      if (info.host === Office.HostType.Word) {
        document.addEventListener("DOMContentLoaded", () => {
          // provider ÂèòÂåñÊó∂Êõ¥Êñ∞ label + link + key
          const providerSelect = document.getElementById("providerSelect");
          if (providerSelect) {
            providerSelect.addEventListener("change", () => {
              updateApiKeyLabelAndLink();
              loadSavedApiKey();
              clearStatus("saveStatus");
            });
          }

          // ÁªëÂÆöÊåâÈíÆ
          const saveBtn = document.getElementById("saveKeyBtn");
          if (saveBtn) saveBtn.onclick = saveApiKey;

          const genBtn = document.getElementById("generateBtn");
          if (genBtn) genBtn.onclick = handleGenerate;

          const btnRewrite = document.getElementById("btnRewrite");
          const btnSummarize = document.getElementById("btnSummarize");
          const btnExpand = document.getElementById("btnExpand");
          const btnFormat = document.getElementById("btnFormat");

          if (btnRewrite) btnRewrite.onclick = () => handleEdit("rewrite");
          if (btnSummarize) btnSummarize.onclick = () => handleEdit("summarize");
          if (btnExpand)   btnExpand.onclick   = () => handleEdit("expand");
          if (btnFormat)   btnFormat.onclick   = () => handleEdit("format");

          // ÂàùÂßãÂåñ
          updateApiKeyLabelAndLink();
          loadSavedApiKey();
        });
      }
    });
  </script>
</body>
</html>
