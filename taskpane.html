<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BYOK AI Assistant</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 18px;
            color: #333;
        }

        .section {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 18px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-primary {
            background: #0078D4;
            color: #ffffff;
        }

        .btn-primary:disabled {
            opacity: 0.7;
            cursor: default;
        }

        .btn-secondary {
            background: #efefef;
            color: #333;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .info-text {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .status {
            font-size: 12px;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            display: none;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            display: block;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            display: block;
        }

        #accountSection {
            border-left: 4px solid #0078D4;
        }

        #premiumCTA {
            margin-top: 10px;
            font-size: 13px;
            color: #0078D4;
        }

        a.link {
            font-size: 12px;
            color: #0078D4;
            text-decoration: none;
        }

        a.link:hover {
            text-decoration: underline;
        }
        .collapsed {
            display: none !important;
        }
    </style>
</head>

<body>

    <!-- ğŸ‘¤ Account & Trial -->
    <div class="section" id="accountSection">
    
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div id="premiumStatus" style="font-size:14px;font-weight:600;color:#2e7d32;">
                ğŸ”¥ Lifetime Access
            </div>
    
            <button id="toggleManagement" class="btn-secondary" 
                style="width:auto;padding:4px 8px;font-size:11px;margin:0;display:none;">
                âš™ï¸ Manage
            </button>
        </div>
    
        <div id="licenseManagementArea" class="collapsed">
            <input type="email" id="userEmailInput" placeholder="Enter your emailâ€¦"/>
            <button class="btn-secondary" id="saveEmailBtn">ğŸ’¾ Save Email</button>
    
            <div class="info-text" id="emailDisplay">Not saved yet.</div>
            <div class="status" id="trialStatus"></div>
            <div id="premiumCTA" style="margin-top:10px;"></div>
        </div>
    </div>

    
    <!-- ğŸ”‘ API -->
    <div class="section">
    
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div id="apiKeySavedStatus" style="font-size:14px;font-weight:600;color:#333;">
                ğŸ”‘ AI Model & Key
            </div>
    
            <button id="toggleApiKeyManagement" class="btn-secondary"
                style="width:auto;padding:4px 8px;font-size:11px;margin:0;display:none;">
                âš™ï¸ Manage
            </button>
        </div>
    
        <div id="apiKeyManagementArea" class="collapsed">
    
            <label for="modelSelect" style="font-size:13px;font-weight:500;margin-top:10px;">Model</label>
            <select id="modelSelect">
                <option value="gemini">Google Gemini 2.0 Flash</option>
                <option value="openai">OpenAI GPT-4o</option>
                <option value="claude">Claude 3.5 Sonnet</option>
            </select>
    
            <label id="apiKeyLabel"></label>
            <input type="password" id="apiKeyInput" placeholder="Paste your API keyâ€¦"/>
    
            <div style="display:flex;justify-content:space-between;margin-top:10px;">
                <a href="#" target="_blank" id="getKeyLink" class="link"></a>
                <button class="btn-primary" id="saveApiKeyBtn">ğŸ’¾ Save Key</button>
            </div>
    
            <div class="status" id="saveStatus"></div>
        </div>
    
    </div>
    <!-- âœ¨ Generate -->
    <div class="section">
        <div class="section-title">âœ¨ Generate Content</div>
        <div class="info-text">ğŸ“ Inserts at cursor position</div>

        <textarea id="promptInput" placeholder="e.g., Write an introduction about AI and productivity..."></textarea>

        <button class="btn-primary" id="generateBtn">âœ¨ Generate & Insert</button>
        <div id="generateStatus" class="status"></div>
    </div>

    <!-- ğŸ“ Edit -->
    <div class="section">
        <div class="section-title">ğŸ“ Edit Selection</div>
        <div class="info-text">âœ¨ Highlight text first</div>

        <div class="btn-grid">
            <button class="btn-secondary" data-action="rewrite">âœï¸ Rewrite</button>
            <button class="btn-secondary" data-action="summarize">ğŸ“„ Summarize</button>
            <button class="btn-secondary" data-action="expand">ğŸ“ˆ Expand</button>
            <button class="btn-secondary" data-action="format">âœ¨ Format</button>
        </div>
        <div class="section">
            <div class="section-title">ğŸŒ Translate Text</div>
            <div class="info-text">âœ¨ Highlight text first</div>

            <select id="translateLang">
                <option value="zh">Chinese ä¸­æ–‡</option>
                <option value="es">Spanish EspaÃ±ol</option>
                <option value="ja">Japanese æ—¥æœ¬èª</option>
                <option value="de">German Deutsch</option>
                <option value="fr">French FranÃ§ais</option>
                <option value="pt">Portuguese PortuguÃªs</option>
                <option value="ko">Korean í•œêµ­ì–´</option>
                <option value="hi">Hindi à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                <option value="it">Italian Italiano</option>
                <option value="ru">Russian Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
            </select>

            <button class="btn-secondary" onclick="translateSelected()">ğŸŒ Translate Selected</button>

            <div id="translateStatus" class="status"></div>
        </div>
        <textarea id="customInstruction" placeholder="Or enter custom instruction..."></textarea>

        <button class="btn-primary" id="runCustomBtn">ğŸš€ Run on Selected</button>

        <div id="editStatus" class="status"></div>
    </div>
<script>
    /*************************************************************
     * Office Initialization
     *************************************************************/
    let isPremiumActive = false; // å…¨å±€å˜é‡ï¼Œç”¨äºæ ‡è®°ä»˜è´¹çŠ¶æ€

    Office.onReady(() => {
        console.log("Office ready.");

        // æŒ‰é’®ç»‘å®š
        document.getElementById("saveApiKeyBtn").addEventListener("click", saveApiKey);
        document.getElementById("generateBtn").addEventListener("click", generateContent);
        
        // â­ NEW: API Key æŠ˜å æŒ‰é’®äº‹ä»¶
        document.getElementById("toggleApiKeyManagement").addEventListener("click", toggleApiKeyManagement);
        // Email æŠ˜å æŒ‰é’®äº‹ä»¶
        document.getElementById("toggleManagement").addEventListener("click", toggleLicenseManagement);

        document.getElementById("modelSelect").addEventListener("change", () => {
            updateApiKeyLabel();
            updateGetKeyLink();
            updateApiKeyUI(); // â­ NEW: æ¨¡å‹åˆ‡æ¢åç«‹å³æ›´æ–° API UI
        });

        // Preset edit buttons
        document.querySelectorAll("[data-action]").forEach(btn => {
            btn.addEventListener("click", () => editPreset(btn.dataset.action));
        });

        // Custom instruction button
        document.getElementById("runCustomBtn").addEventListener("click", runCustom);

        // Email / Trial / License init
        document.getElementById("saveEmailBtn").addEventListener("click", saveUserEmail);

        // åˆå§‹åŒ–å’Œè®¸å¯è¯æ£€æŸ¥
        initUserEmailAndTrial();
        updateApiKeyLabel();
        updateGetKeyLink();
        
        // â­ NEW: å¯åŠ¨æ—¶æ£€æŸ¥ API key çŠ¶æ€å¹¶æŠ˜å 
        updateApiKeyUI();
        
        // å¯åŠ¨æ—¶ç«‹å³æ£€æŸ¥è®¸å¯è¯
        checkLicenseAndUpdateUI(); 
    });
    
    // ===================================
    // New Function: åˆ‡æ¢ API ç®¡ç†åŒºçš„æ˜¾ç¤ºçŠ¶æ€
    // ===================================
    function toggleApiKeyManagement() {
        const manageEl = document.getElementById("apiKeyManagementArea");
        const toggleBtn = document.getElementById("toggleApiKeyManagement");

        if (manageEl.classList.contains('collapsed')) {
            manageEl.classList.remove('collapsed');
            toggleBtn.textContent = 'âš™ï¸ Close';
        } else {
            manageEl.classList.add('collapsed');
            toggleBtn.textContent = 'âš™ï¸ Manage';
        }
    }

    // ===================================
    // New Function: åˆ‡æ¢ Email ç®¡ç†åŒºçš„æ˜¾ç¤ºçŠ¶æ€
    // ===================================
    function toggleLicenseManagement() {
        const manageEl = document.getElementById("licenseManagementArea");
        const toggleBtn = document.getElementById("toggleManagement");

        if (manageEl.classList.contains('collapsed')) {
            manageEl.classList.remove('collapsed');
            toggleBtn.textContent = 'âš™ï¸ Close';
        } else {
            manageEl.classList.add('collapsed');
            toggleBtn.textContent = 'âš™ï¸ Manage';
        }
    }

    /*************************************************************
     * Step 1 â€” Email + Trial + Lemon Squeezy Purchase
     *************************************************************/
    const TRIAL_DAYS = 5;

    // Lemon checkout link
    const LS_CHECKOUT_URL =
        "https://ai-office-addins.lemonsqueezy.com/buy/6b60bcc8-c9e2-4fcf-a1d7-4137e19845a5";

    function openLsCheckout() {
        let email = localStorage.getItem("byok_user_email");

        // If email not saved, try reading input
        if (!email) {
            const input = document.getElementById("userEmailInput");
            if (input) email = input.value.trim();
        }

        if (!email || !email.includes("@")) {
            alert("Please enter your email first so we can activate your license after purchase.");
            return;
        }

        localStorage.setItem("byok_user_email", email);

        // Pre-fill email to Lemon checkout
        const finalUrl =
            `${LS_CHECKOUT_URL}?checkout[customer_email]=${encodeURIComponent(email)}`;

        window.open(finalUrl, "_blank");
    }

    function initUserEmailAndTrial() {
        console.log("Initialize Email + Trial");

        const savedEmail = localStorage.getItem("byok_user_email");
        if (savedEmail) {
            document.getElementById("userEmailInput").value = savedEmail;
            updateEmailDisplay(savedEmail);
        }

        let start = localStorage.getItem("byok_trial_start");
        if (!start) {
            start = Date.now().toString();
            localStorage.setItem("byok_trial_start", start);
        }

        updateTrialStatus();
    }

    function saveUserEmail() {
        const emailInput = document.getElementById("userEmailInput");
        const email = emailInput.value.trim();

        if (!email || !email.includes("@")) {
            showStatus("saveStatus", "âš ï¸ Please enter a valid email", "error");
            return;
        }

        localStorage.setItem("byok_user_email", email);
        updateEmailDisplay(email);

        showStatus("saveStatus", "âœ… Email saved", "success");

        updateTrialStatus();
        checkLicenseAndUpdateUI(); 
    }

    function updateEmailDisplay(email) {
        document.getElementById("emailDisplay").textContent = `Using email: ${email}`;
    }

    /*************************************************************
     * Trial Status (ç¡®ä¿ä»˜è´¹åéšè—è¯•ç”¨ä¿¡æ¯)
     *************************************************************/
    function updateTrialStatus() {
        const trialEl = document.getElementById("trialStatus");
        const ctaEl = document.getElementById("premiumCTA");
    
        if (isPremiumActive) {
            trialEl.style.display = "none";
            ctaEl.style.display = "none";
            return;
        }
    
        const start = Number(localStorage.getItem("byok_trial_start") || Date.now());
        const now = Date.now();
        const daysUsed = Math.floor((now - start) / (24 * 3600 * 1000));
        const daysLeft = TRIAL_DAYS - daysUsed;
    
        if (daysLeft > 0) {
            trialEl.className = "status success";
            trialEl.textContent = `ğŸŸ¢ Free trial: ${daysLeft} day(s) remaining`;
            trialEl.style.display = "block";
    
            ctaEl.style.display = "block";
            ctaEl.innerHTML = `
                â­ Enjoying it?<br>
                <button id="buyButton" class="btn-primary" style="margin-top:8px;">
                    ğŸ”’ Buy lifetime license â€“ $19.90
                </button>`;
        } else {
            trialEl.className = "status error";
            trialEl.textContent = "ğŸ”´ Free trial ended â€” upgrade required";
            trialEl.style.display = "block";
    
            ctaEl.style.display = "block";
            ctaEl.innerHTML = `
                â­ Lifetime access available<br>
                <button id="buyButton" class="btn-primary" style="margin-top:8px;">
                    ğŸ”’ Buy lifetime license â€“ $19.90
                </button>`;
        }
    
        // ç»‘å®šè´­ä¹°æŒ‰é’®
        setTimeout(() => {
            const btn = document.getElementById("buyButton");
            if (btn) btn.addEventListener("click", openLsCheckout);
        }, 0);
    }


    /*************************************************************
     * Model Config â€” Gemini 2.0 Flash
     *************************************************************/
    const modelConfig = {
        gemini: {
            name: "Gemini API Key",
            link: "https://aistudio.google.com/app/apikey",
            endpoint:
                "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent"
        },
        openai: {
            name: "OpenAI API Key",
            link: "https://platform.openai.com/api-keys",
            endpoint: "https://api.openai.com/v1/chat/completions"
        },
        claude: {
            name: "Anthropic API Key",
            link: "https://console.anthropic.com/",
            endpoint: "https://api.anthropic.com/v1/messages"
        }
    };
    
    // â­ NEW: æ ¹æ® API Key çŠ¶æ€æ›´æ–° UI (Key Management)
    function updateApiKeyUI() {
        const model = document.getElementById("modelSelect").value;
        const apiKey = localStorage.getItem(`apiKey_${model}`);
        const cfg = modelConfig[model];
    
        const statusEl = document.getElementById("apiKeySavedStatus");
        const manageEl = document.getElementById("apiKeyManagementArea");
        const toggleBtn = document.getElementById("toggleApiKeyManagement");
    
        if (apiKey) {
            // å·²ä¿å­˜ API key â†’ æŠ˜å ç®¡ç†ç•Œé¢
            statusEl.textContent = `ğŸ”‘ AI Model & Key`;
            manageEl.classList.add("collapsed");
            toggleBtn.style.display = "inline-block";
            toggleBtn.textContent = "âš™ï¸ Manage";
        } else {
            // æœªä¿å­˜ â†’ å±•å¼€ç®¡ç†ç•Œé¢
            statusEl.textContent = `âš ï¸ Please enter your ${cfg.name}`;
            manageEl.classList.remove("collapsed");
            toggleBtn.style.display = "none";
        }
    }


    function updateApiKeyLabel() {
        const model = document.getElementById("modelSelect").value;
        const cfg = modelConfig[model];
        document.getElementById("apiKeyLabel").textContent = cfg.name;

        const saved = localStorage.getItem(`apiKey_${model}`);
        document.getElementById("apiKeyInput").value = saved || "";
    }

    function updateGetKeyLink() {
        const model = document.getElementById("modelSelect").value;
        const linkEl = document.getElementById("getKeyLink");

        linkEl.style.display = "inline-block";

        if (model === "gemini") {
            linkEl.href = modelConfig.gemini.link;
            linkEl.textContent = "ğŸ‘‰ Get free Gemini API key";
        } else if (model === "openai") {
            linkEl.href = modelConfig.openai.link;
            linkEl.textContent = "ğŸ‘‰ Get OpenAI API key";
        } else {
            linkEl.href = modelConfig.claude.link;
            linkEl.textContent = "ğŸ‘‰ Get Anthropic API key";
        }
    }

    function saveApiKey() {
        const model = document.getElementById("modelSelect").value;
        const key = document.getElementById("apiKeyInput").value.trim();

        if (!key) {
            showStatus("saveStatus", "âš ï¸ Please enter an API key", "error");
            return;
        }

        localStorage.setItem(`apiKey_${model}`, key);
        showStatus("saveStatus", "API key saved! âœ…", "success");
        
        // â­ NEW: ä¿å­˜åæŠ˜å  UI
        updateApiKeyUI(model); 
    }

    /*************************************************************
     * Generate Content (Rest of functions remain the same)
     *************************************************************/
    // ... (generateContent, editPreset, translateSelected, runCustom, callAI, insertText, showStatus functions) ...
    async function generateContent() {
        const prompt = document.getElementById("promptInput").value.trim();
        if (!prompt) {
            showStatus("generateStatus", "âš ï¸ Please enter a prompt", "error");
            return;
        }

        const model = document.getElementById("modelSelect").value;
        const apiKey = localStorage.getItem(`apiKey_${model}`);
        if (!apiKey) {
            showStatus("generateStatus", "âš ï¸ Save your API key first", "error");
            return;
        }

        const btn = document.getElementById("generateBtn");
        btn.disabled = true;
        btn.textContent = "â³ Generatingâ€¦";

        try {
            const result = await callAI(model, apiKey, prompt);
            await insertText(result);
            showStatus("generateStatus", "Inserted successfully! ğŸ‰", "success");
        } catch (err) {
            console.error(err);
            showStatus("generateStatus", "âŒ " + err.message, "error");
        } finally {
            btn.disabled = false;
            btn.textContent = "âœ¨ Generate & Insert";
        }
    }

    async function editPreset(action) {
        const model = document.getElementById("modelSelect").value;
        const apiKey = localStorage.getItem(`apiKey_${model}`);

        if (!apiKey) {
            showStatus("editStatus", "âš ï¸ Save your API key first", "error");
            return;
        }

        try {
            await Word.run(async (context) => {
                const selection = context.document.getSelection();
                selection.load("text");
                await context.sync();

                const selectedText = selection.text.trim();
                if (!selectedText) {
                    showStatus("editStatus", "âš ï¸ Select some text first", "error");
                    return;
                }

                const prompts = {
                    rewrite: `Rewrite this text clearly and professionally:\n\n${selectedText}`,
                    summarize: `Summarize the following text:\n\n${selectedText}`,
                    expand: `Expand on this text with more details:\n\n${selectedText}`,
                    format: `Improve the formatting and clarity:\n\n${selectedText}`
                };

                const prompt = prompts[action];
                const response = await callAI(model, apiKey, prompt);

                selection.insertText(response, Word.InsertLocation.replace);
                await context.sync();

                showStatus("editStatus", "Done! ğŸ‰", "success");
            });
        } catch (err) {
            console.error(err);
            showStatus("editStatus", "âŒ " + err.message, "error");
        }
    }

    async function translateSelected() {
        const model = document.getElementById("modelSelect").value;
        const apiKey = localStorage.getItem(`apiKey_${model}`);
        const lang = document.getElementById("translateLang").value;

        if (!apiKey) {
            showStatus("translateStatus", "âš ï¸ Save your API key first", "error");
            return;
        }

        try {
            await Word.run(async (context) => {
                const selection = context.document.getSelection();
                selection.load("text");
                await context.sync();

                if (!selection.text.trim()) {
                    showStatus("translateStatus", "âš ï¸ Select text first", "error");
                    return;
                }

                const prompt = `
Translate the following text into ${lang}.
Return ONLY the translated text.

Text:
${selection.text.trim()}
            `;

                const result = await callAI(model, apiKey, prompt);

                selection.insertText(result, Word.InsertLocation.replace);
                await context.sync();

                showStatus("translateStatus", "âœ… Translated!", "success");
            });
        } catch (err) {
            console.error(err);
            showStatus("translateStatus", "âŒ " + err.message, "error");
        }
    }

    async function runCustom() {
        const instruction = document.getElementById("customInstruction").value.trim();
        if (!instruction) {
            showStatus("editStatus", "âš ï¸ Enter a custom instruction", "error");
            return;
        }

        const model = document.getElementById("modelSelect").value;
        const apiKey = localStorage.getItem(`apiKey_${model}`);
        if (!apiKey) {
            showStatus("editStatus", "âš ï¸ Save your API key first", "error");
            return;
        }

        try {
            await Word.run(async (context) => {
                const selection = context.document.getSelection();
                selection.load("text");
                await context.sync();

                const selected = selection.text.trim();
                if (!selected) {
                    showStatus("editStatus", "âš ï¸ Select text first", "error");
                    return;
                }

                const prompt = `${instruction}\n\nText:\n${selected}`;
                const output = await callAI(model, apiKey, prompt);

                selection.insertText(output, Word.InsertLocation.replace);
                await context.sync();

                showStatus("editStatus", "âœ… Custom applied!", "success");
            });
        } catch (err) {
            console.error(err);
            showStatus("editStatus", "âŒ " + err.message, "error");
        }
    }

    async function callAI(model, apiKey, prompt) {
        const cfg = modelConfig[model];

        // --- Gemini 2.0 Flash ---
        if (model === "gemini") {
            const url = `${cfg.endpoint}?key=${apiKey}`;
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error?.message || "Gemini Error");

            return data.candidates[0].content.parts[0].text;
        }

        // --- OpenAI GPT-4o ---
        if (model === "openai") {
            const res = await fetch(cfg.endpoint, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-4o",
                    messages: [{ role: "user", content: prompt }]
                })
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error?.message || "OpenAI Error");

            return data.choices[0].message.content;
        }

        // --- Claude 3.5 Sonnet ---
        if (model === "claude") {
            const res = await fetch(cfg.endpoint, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": apiKey,
                    "anthropic-version": "2023-06-01"
                },
                body: JSON.stringify({
                    model: "claude-3-5-sonnet-20241022",
                    max_tokens: 2000,
                    messages: [{ role: "user", content: prompt }]
                })
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error?.message || "Claude Error");

            return data.content[0].text;
        }

        throw new Error("Model not implemented.");
    }

    async function insertText(text) {
        await Word.run(async (context) => {
            const selection = context.document.getSelection();
            selection.insertText(text, Word.InsertLocation.end);
            await context.sync();
        });
    }

    function showStatus(id, msg, type) {
        const el = document.getElementById(id);
        el.textContent = msg;
        el.className = `status ${type}`;
        el.style.display = "block";

        if (id !== "trialStatus") {
            setTimeout(() => { el.style.display = "none"; }, 3500);
        }
    }


    // Cloud Run License Check URL
    const CHECK_LICENSE_URL = "https://checklicense-h5obtbbyra-uc.a.run.app";

    async function callCheckLicense(email) {
        try {
            const url = `${CHECK_LICENSE_URL}?email=${encodeURIComponent(email)}`;
            const res = await fetch(url);
            return await res.json();
        } catch (err) {
            console.error("License check failed:", err);
            return { active: false };
        }
    }

    // =================================
    // ğŸ”“ Update UI based on license
    // =================================
    async function checkLicenseAndUpdateUI() {
        const email = localStorage.getItem("byok_user_email");
        const statusEl = document.getElementById("premiumStatus");
        const trialEl = document.getElementById("trialStatus");
        const ctaEl = document.getElementById("premiumCTA");
        const manageArea = document.getElementById("licenseManagementArea");
        const toggleBtn = document.getElementById("toggleManagement");
    
        if (!email) {
            // æœªä¿å­˜é‚®ç®± â†’ å±•å¼€è®¾ç½®åŒº
            if (statusEl) statusEl.textContent = "ğŸ”’ Please enter your email";
            manageArea.classList.remove("collapsed");
            toggleBtn.style.display = "none";
            isPremiumActive = false;
            return;
        }
    
        const result = await callCheckLicense(email);
        console.log("ğŸ” License result:", result);
    
        if (result.active === true) {
            // ============ PREMIUM æ¿€æ´» =============
    
            isPremiumActive = true;
    
            // é¡¶éƒ¨çŠ¶æ€
            statusEl.textContent = "ğŸ”¥ Premium Access";
            statusEl.style.color = "#2e7d32";
    
            // éšè—è¯•ç”¨ UI
            trialEl.style.display = "none";
            ctaEl.style.display = "none";
    
            // æŠ˜å è®¾ç½®åŒº + æ˜¾ç¤º Manage æŒ‰é’®
            manageArea.classList.add("collapsed");
            toggleBtn.style.display = "inline-block";
            toggleBtn.textContent = "âš™ï¸ Manage";
    
        } else {
            // ============ Free Trial / æœªæ¿€æ´» =============
    
            isPremiumActive = false;
    
            // é¡¶éƒ¨çŠ¶æ€
            statusEl.textContent = "ğŸ”’ Free trial / Upgrade required";
            statusEl.style.color = "#c62828";
    
            // å±•å¼€è®¾ç½®åŒº + éšè— Manageï¼ˆå› ä¸ºä¸æ¿€æ´»ä¸èƒ½æŠ˜å ï¼‰
            manageArea.classList.remove("collapsed");
            toggleBtn.style.display = "none";
    
            updateTrialStatus();
        }
    }
</script>
</body>

</html>
